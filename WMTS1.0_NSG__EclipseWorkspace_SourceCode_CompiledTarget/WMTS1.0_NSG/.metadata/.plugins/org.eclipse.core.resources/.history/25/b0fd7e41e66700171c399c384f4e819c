package nsg.wmts10.testsuite.gettile;

import ets.wmts10.testsuite.gettile.AbstractBaseGetTileFixture;
import nsg.wmts10.testsuite.getcapabilities.GetCapabilitiesKvpFormatTest;

import java.net.URI;
import java.util.List;

import javax.xml.xpath.XPathFactory;
import javax.xml.xpath.XPathFactoryConfigurationException;
import javax.ws.rs.core.CacheControl;
import javax.ws.rs.core.HttpHeaders;
import javax.xml.xpath.XPath;
import javax.xml.xpath.XPathConstants;
import javax.xml.xpath.XPathExpressionException;

import org.w3c.dom.Node;
import org.w3c.dom.NodeList;

import org.testng.ITestContext;
import org.testng.annotations.Test;
import org.testng.asserts.SoftAssert;

import static org.testng.Assert.assertFalse;
import static org.testng.Assert.assertTrue;

import com.sun.jersey.api.client.ClientResponse;

import de.latlon.ets.core.error.ErrorMessage;
import de.latlon.ets.core.error.ErrorMessageKey;
import static ets.wmts10.core.assertion.WmtsAssertion.assertStatusCode;
import static ets.wmts10.core.assertion.WmtsAssertion.assertContentType;
import ets.wmts10.core.domain.ProtocolBinding;
import ets.wmts10.core.domain.WMTS_Constants;
import ets.wmts10.core.util.ServiceMetadataUtils;


public class GetTileCachingInfo extends AbstractBaseGetTileFixture
{
/*---
	NSG Requirement 19: 
		: An NSG WMTS server shall provide caching information (expiration date) for the data. 	
---*/
		
	private URI getTileURI = null;
	
	private ClientResponse response = null;
	private List<String> cacheControls = null; 
	private List<String> expires = null; 
	
	//private boolean _debug = false;
	
	// ---
	
	@Test(description = "NSG Web Map Tile Service (WMTS) 1.0.0, Requirement 19", dependsOnMethods = "verifyGetTileSupported")
	public void wmtsGetTileKVPRequestsExists() 
	{
		getTileURI = ServiceMetadataUtils.getOperationEndpoint_KVP( this.wmtsCapabilities, WMTS_Constants.GET_TILE, ProtocolBinding.GET );
		assertTrue(getTileURI != null, "GetTile (GET) endpoint not found or KVP is not supported in ServiceMetadata capabilities document.");
	}
	   
	// ---
	   
	@Test(description = "NSG Web Map Tile Service (WMTS) 1.0.0, Requirement 19", dependsOnMethods = "wmtsGetTileKVPRequestsExists")
	public void wmtsGetTileCachingInformationExists()
	{
		if ( getTileURI == null )
		{
			getTileURI = ServiceMetadataUtils.getOperationEndpoint_KVP( this.wmtsCapabilities, WMTS_Constants.GET_TILE, ProtocolBinding.GET );
		}
		
		this.reqEntity.removeKvp( WMTS_Constants.FORMAT_PARAM );
		String requestFormat = WMTS_Constants.IMAGE_PNG;
		this.reqEntity.addKvp(WMTS_Constants.FORMAT_PARAM, requestFormat);

		response = wmtsClient.submitRequest( this.reqEntity, getTileURI );
        
		storeResponseImage( response, "Requirement19", "simple", requestFormat );

		assertTrue( response.hasEntity(), ErrorMessage.get( ErrorMessageKey.MISSING_XML_ENTITY ) );
		assertStatusCode(  response.getStatus(),  200 );
		assertContentType( response.getHeaders(), requestFormat );
		
		cacheControls = response.getHeaders().get( "Cache-control" );
		expires       = response.getHeaders().get( "Expires" );
		
		boolean anyCacheControls = (( cacheControls != null ) && ( cacheControls.size() > 0 ));
		boolean anyExpires       = (( expires       != null ) && ( expires.size()       > 0 ));
		assertTrue(anyCacheControls || anyExpires, "WMTS does not provide appropriate caching information");
	}
	
	// ---
				
	@Test(description = "NSG Web Map Tile Service (WMTS) 1.0.0, Requirement 19", dependsOnMethods = "wmtsGetTileCachingInformationExists")
	public void wmtsGetTileExpirationExists()
	{
		boolean hasExpiration = false;
		if (( expires != null ) && ( expires.size() > 0 ))
		{
			hasExpiration = true;
		}
		
		if (( cacheControls != null ) && ( cacheControls.size() > 0 ))
		{
			String cacheControl = cacheControls.get(0);
			hasExpiration |= ( cacheControl.contains("max-age") || cacheControl.contains("maxage"));
		}
		
		assertTrue(hasExpiration, "WMTS has cache-control or expiration headers, but no expiration time or date is found.");	
	}
	
	// ---
	
	}
/* --    
	private XPath createXPath()
               throws XPathFactoryConfigurationException
	{
		XPathFactory factory = XPathFactory.newInstance( XPathConstants.DOM_OBJECT_MODEL );
		XPath xpath = factory.newXPath();
		xpath.setNamespaceContext( NS_BINDINGS );
		return xpath;
	}
/*  --*/
}